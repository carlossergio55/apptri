@using System.Collections
@using Infraestructura.Models.Authentication
@layout MainLayout
<div align="center">
    <MudText Typo="Typo.subtitle1">Administración</MudText>
</div>

<MudDivider Class="mb-4" />

<MudNavMenu Bordered="true" Dense="true">
    <MudNavLink Href="/dashboard" Match="NavLinkMatch.All" Icon="@Icons.Material.Outlined.Dashboard" IconColor="Color.Primary">
        DASHBOARD
    </MudNavLink>

    <MudNavGroup Title="Pasajes" Icon="@Icons.Material.Outlined.ConfirmationNumber">
        <MudNavLink Href="/VentaAdmin" Icon="@Icons.Material.Outlined.PointOfSale">Venta de Pasajes</MudNavLink>
        <MudNavLink Href="/reservas" Icon="@Icons.Material.Outlined.Bookmark">Reservas</MudNavLink>
        <MudNavLink Href="/cancelaciones" Icon="@Icons.Material.Outlined.Cancel">Cancelaciones</MudNavLink>
    </MudNavGroup>

    <MudNavGroup Title="Encomiendas" Icon="@Icons.Material.Outlined.LocalShipping">
        <MudNavLink Href="/envios" Icon="@Icons.Material.Outlined.Send">Enviar Encomienda</MudNavLink>
        <MudNavLink Href="/seguimiento" Icon="@Icons.Material.Outlined.Search">Seguimiento</MudNavLink>
        <MudNavLink Href="/recepciones" Icon="@Icons.Material.Outlined.ReceiptLong">Recepción</MudNavLink>
    </MudNavGroup>

    <MudNavGroup Title="Choferes" Icon="@Icons.Material.Outlined.Person">
        <MudNavLink Href="/choferes" Icon="@Icons.Material.Outlined.List">Lista de Choferes</MudNavLink>
        <MudNavLink Href="/turnos" Icon="@Icons.Material.Outlined.Schedule">Turnos</MudNavLink>
        <MudNavLink Href="/asignaciones" Icon="@Icons.Material.Outlined.Assignment">Asignaciones</MudNavLink>
    </MudNavGroup>

    <MudNavGroup Title="Unidades" Icon="@Icons.Material.Outlined.DirectionsBus">
        <MudNavLink Href="/buses" Icon="@Icons.Material.Outlined.DirectionsBusFilled">Flota</MudNavLink>
        <MudNavLink Href="/mantenimientos" Icon="@Icons.Material.Outlined.Build">Mantenimiento</MudNavLink>
        <MudNavLink Href="/rutas" Icon="@Icons.Material.Outlined.Map">Rutas</MudNavLink>
    </MudNavGroup>

    <MudNavGroup Title="Reportes" Icon="@Icons.Material.Outlined.BarChart">
        <MudNavLink Href="/reportes/ventas" Icon="@Icons.Material.Outlined.Money">Ventas</MudNavLink>
        <MudNavLink Href="/reportes/encomiendas" Icon="@Icons.Material.Outlined.LocalPostOffice">Encomiendas</MudNavLink>
        <MudNavLink Href="/reportes/choferes" Icon="@Icons.Material.Outlined.Assessment">Choferes</MudNavLink>
    </MudNavGroup>

    <MudNavGroup Title="Configuración" Icon="@Icons.Material.Outlined.Settings">
        <MudNavLink Href="/usuarios" Icon="@Icons.Material.Outlined.ManageAccounts">Usuarios</MudNavLink>
        <MudNavLink Href="/roles" Icon="@Icons.Material.Outlined.Security">Roles</MudNavLink>
        <MudNavLink Href="/parametros" Icon="@Icons.Material.Outlined.Tune">Parámetros</MudNavLink>
    </MudNavGroup>
   

    @if (_menuListaPrinci == null)
    {
        <p><em>Cargando...</em></p>
    }
    else
    {
        @foreach (SegMenuResponse item in _menuListaPrinci)
        {
            // Hijos de primer nivel
            var _menuListadetalle = _menuLista.Where(x => x.parentid == item.id).ToList();

            // Si tiene hijos => MudNavGroup
            if (_menuListadetalle.Count > 0)
            {
                <MudNavGroup Title="@item.texto.ToUpper()" Icon="@GetIcon(item.IconoModulo)">
                    @foreach (SegMenuResponse items in _menuListadetalle)
                    {
                        // Hijos de segundo nivel
                        var _menuListadetalle2 = _menuLista.Where(x => x.parentid == items.id).ToList();

                        if (_menuListadetalle2.Count > 0)
                        {
                            <MudNavGroup Title="@items.texto" Icon="@GetIcon(items.IconoModulo)">
                                @foreach (SegMenuResponse items2 in _menuListadetalle2)
                                {
                                    <MudNavLink Href="@items2.url" Icon="@GetIcon(items2.IconoModulo)">
                                        @items2.texto.ToUpper()
                                    </MudNavLink>
                                }
                            </MudNavGroup>
                        }
                        else
                        {
                            <MudNavLink Href="@items.url" Icon="@GetIcon(items.IconoModulo)">
                                @items.texto.ToUpper()
                            </MudNavLink>
                        }
                    }
                </MudNavGroup>
            }
            else
            {
                // Sin hijos => MudNavLink
                <MudNavLink Href="@item.url"
                            Match="NavLinkMatch.All"
                            Icon="@GetIcon(item.IconoModulo)">
                    @item.texto.ToUpper()
                </MudNavLink>
            }
        }
    }
</MudNavMenu>

@code {

    @code {
        private List<SegMenuResponse> _menuListaPrinci;
        private List<SegMenuResponse> _menuLista = new();

        protected override async Task OnInitializedAsync()
        {
            var resultado = await _Storage.DatosMenu();
            _menuLista = resultado?.ToList() ?? new List<SegMenuResponse>(); // <- CORREGIDO
            _menuListaPrinci = _menuLista.Where(x => x.parentid < 0).ToList();
        }

   
    }



    /// <summary>
    /// Convierte el string de la BD (p.ej. "Icons.Material.Filled.Home")
    /// en la referencia estática real de MudBlazor por reflexión.
    /// </summary>
    private string GetIcon(string iconName)
    {
        // Si no hay nada, asignar ícono por defecto
        if (string.IsNullOrEmpty(iconName))
        {
            iconName = "Icons.Material.Outlined.Dashboard"; // Ajusta si quieres otro default
        }

        // iconName se espera con este formato: "Icons.Material.[Filled|Outlined|Rounded|Sharp|TwoTone].NombreIcono"
        // Ej: "Icons.Material.Filled.Home"
        var parts = iconName.Split('.');
        if (parts.Length != 4)
        {
            // formato inválido => retorna un ícono por defecto o un string vacío
            return Icons.Material.Outlined.HelpOutline;
        }

        // Extraemos la categoría => Filled, Outlined, Rounded, Sharp, TwoTone
        string iconCategory = parts[2];
        // Extraemos el nombre real del icono => "Home", "Dashboard", "Person", etc.
        string iconType = parts[3];

        string iconValue = null;

        switch (iconCategory)
        {
            case "Outlined":
                {
                    var outlinedIcons = typeof(Icons.Material.Outlined);
                    var outlinedField = outlinedIcons.GetField(iconType);
                    if (outlinedField != null)
                    {
                        iconValue = (string)outlinedField.GetValue(null);
                    }
                    break;
                }
            case "Filled":
                {
                    var filledIcons = typeof(Icons.Material.Filled);
                    var filledField = filledIcons.GetField(iconType);
                    if (filledField != null)
                    {
                        iconValue = (string)filledField.GetValue(null);
                    }
                    break;
                }
            case "Rounded":
                {
                    var roundedIcons = typeof(Icons.Material.Rounded);
                    var roundedField = roundedIcons.GetField(iconType);
                    if (roundedField != null)
                    {
                        iconValue = (string)roundedField.GetValue(null);
                    }
                    break;
                }
            case "Sharp":
                {
                    var sharpIcons = typeof(Icons.Material.Sharp);
                    var sharpField = sharpIcons.GetField(iconType);
                    if (sharpField != null)
                    {
                        iconValue = (string)sharpField.GetValue(null);
                    }
                    break;
                }
            case "TwoTone":
                {
                    var twoToneIcons = typeof(Icons.Material.TwoTone);
                    var twoToneField = twoToneIcons.GetField(iconType);
                    if (twoToneField != null)
                    {
                        iconValue = (string)twoToneField.GetValue(null);
                    }
                    break;
                }
            default:
                // Si no coincide con ninguno, asignar un ícono fallback
                return Icons.Material.Outlined.HelpOutline;
        }

        // Retornar el ícono encontrado o un fallback si no existe
        return iconValue ?? Icons.Material.Outlined.HelpOutline;
    }

    // Ejemplo de ícono inline si quisieras
    string AlertAssignmentIcon { get; set; } = "<path d=\"M19,3A2,2 0 0,1 21,5V19A2,2 0 0,1 19,21H5A2,2 0 0,1 3,19V5A2,2 0 0,1 5,3H9.18C9.6,1.84 10.7,1 12,1C13.3,1 14.4,1.84 14.82,3H19M12,3A1,1 0 0,0 11,4A1,1 0 0,0 12,5A1,1 0 0,0 13,4A1,1 0 0,0 12,3M7,7V5H5V19H19V5H17V7H7M11,9H13V13.5H11V9M11,15H13V17H11V15Z\" />";
}
