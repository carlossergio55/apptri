@page "/comprar-asiento"
@layout PublicLayout
@inherits MainBaseComponent
@inject NavigationManager Nav
@inject ISnackbar Snackbar

<link href="styles/Integracion/comprar-asiento.css" rel="stylesheet" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />

<!-- STEPPER -->
<MudPaper Elevation="1" Class="comp-public-stepper p-4 rounded-xl mb-4">
    <MudText Typo="Typo.subtitle1" Align="Align.Center" Class="stepper-title mb-2">
        PROCESO DE COMPRA
    </MudText>
    <div class="comp-steps">
        <div class="comp-step completed"><span class="dot"></span><span class="label">Buscar</span></div>
        <div class="comp-bar"></div>
        <div class="comp-step active"><span class="dot"></span><span class="label">Asientos</span></div>
        <div class="comp-bar"></div>
        <div class="comp-step"><span class="dot"></span><span class="label">Datos</span></div>
        <div class="comp-bar"></div>
        <div class="comp-step"><span class="dot"></span><span class="label">Pago</span></div>
    </div>
</MudPaper>

<MudPaper Class="d-flex flex-column align-items-center p-4" Style="gap: 24px;">
    <MudText Typo="Typo.h5" Align="Align.Center" Class="titulo-pasajes-public">
        @(_titulo ?? "Asientos disponibles")
    </MudText>

    <!-- Selector de horarios (chips tipo carrusel) -->
    @if (_horarios is not null && _horarios.Count > 1)
    {
        <MudPaper Class="horarios-container">
            <MudText Typo="Typo.subtitle2" Class="horarios-title">Horarios disponibles</MudText>

            <div class="horarios-scroll">
                @foreach (var h in _horarios)
                {
                    <MudChip Class="horarios-chip"
                             Color="Color.Primary"
                             Variant="Variant.Outlined"
                             Selected="@(_viajeSeleccionadoId == h.IdViaje)"
                             OnClick="@(()=>SeleccionarHorario(h.IdViaje))">
                        @h.Hora
                    </MudChip>
                }
            </div>
        </MudPaper>
    }


    <!-- Leyenda -->
    <MudPaper Class="d-flex justify-center align-items-center flex-wrap" Style="gap: 20px;">
        <MudText Class="d-flex align-items-center" Style="gap: 6px;"><i class="fas fa-chair" style="color: lightgray;"></i> Libre</MudText>
        <MudText Class="d-flex align-items-center" Style="gap: 6px;"><i class="fas fa-chair" style="color: red;"></i> Ocupado</MudText>
        <MudText Class="d-flex align-items-center" Style="gap: 6px;"><i class="fas fa-chair" style="color: green;"></i> Seleccionado</MudText>
        <MudText Class="d-flex align-items-center" Style="gap: 6px;"><i class="fas fa-chair" style="color: gold;"></i> Bloqueado temporalmente</MudText>
        <MudText Class="d-flex align-items-center" Style="gap: 6px;"><i class="fas fa-chair" style="color: orange;"></i> Reservado por llamada</MudText>
    </MudPaper>

    <div class="pasajes-public-bus-layout">
        <!-- Conductor -->
        <div class="pasajes-public-fila-conductor">
            <div class="pasajes-public-conductor-icono">
                <i class="fas fa-user-tie"></i><span>Conductor</span>
            </div>
        </div>

        <!-- Filas principales (2 + pasillo + 2) -->
        @for (int fila = 0; fila < _mainRows; fila++)
        {
            <div class="pasajes-public-fila-bus">
                @for (int col = 0; col < 4; col++)
                {
                    if (col == 2)
                    {
                        <div class="pasajes-public-pasillo"></div>
                        ;
                    }

                    int numero = fila * 4 + (col + 1);
                    var seat = GetSeat(numero);
                    if (seat is null) { continue; }

                    <div class="@SeatCss(seat)" @onclick="(() => Toggle(seat))">
                        <i class="fas fa-chair"><span class="pasajes-public-numero">@numero</span></i>
                    </div>
                }
            </div>
        }

        <!-- Última fila (hasta 5) -->
        @if (_lastRowCount > 0)
        {
            <div class="pasajes-public-ultima-fila">
                @for (int i = _mainRows * 4 + 1; i <= _mainRows * 4 + _lastRowCount; i++)
                {
                    var seat = GetSeat(i);
                    if (seat is null) { continue; }
                    <div class="@SeatCss(seat)" @onclick="(() => Toggle(seat))">
                        <i class="fas fa-chair"><span class="pasajes-public-numero">@i</span></i>
                    </div>
                }
            </div>
        }

        <!-- Resumen / acciones -->
        <div class="pasajes-public-info-resumen">
            Usted ha seleccionado los asientos: <b>@(string.Join(", ", _seleccion.OrderBy(x => x)))</b>

            @if (_boletoId.HasValue && _venceUtc.HasValue)
            {
                <div class="pasajes-public-temporizador">
                    Tiempo restante: <span>@_restante.ToString(@"mm\:ss")</span>
                </div>
                <MudProgressLinear Class="mt-2" Max="100" Value="@_progresoPct" />
            }

            <div class="pasajes-public-botones">
                <a target="_blank" href="@WhatsAppLink()"><button class="pasajes-public-boton wa">Llamar para reservar</button></a>
                <button class="pasajes-public-boton pagar" disabled="@(!BtnPagarHabilitado)" @onclick="IrAPagar">Ir a Pagar</button>
            </div>
        </div>
    </div>
</MudPaper>

<!-- Notas -->
<div class="pasajes-public-notas">
    <div class="pasajes-public-nota">
        ⏳Pasado el tiempo de 10 minutos si no realiza el pago, los asientos se liberarán automáticamente. <br />
        📞Si reserva pasajes mediante llamada y no realiza el pago, el pasaje estará disponible para su venta. <br />
        💸Para pagar pasajes reservados debe ir a nuestras oficinas o solicitar un QR por WhatsApp. <br />
        🔔Los boletos reservados se recogen físicamente. El sistema <strong>no emite boletos</strong> de reserva, solo boletos pagados mediante el mismo.
    </div>
    <div class="pasajes-public-leyenda">
        <strong>Estados de los asientos:</strong><br />
        <i class="fas fa-chair" style="color: lightgray;"></i> Libre — Disponible para seleccionar.<br />
        <i class="fas fa-chair" style="color: red;"></i> Ocupado — Ya ha sido vendido.<br />
        <i class="fas fa-chair" style="color: green;"></i> Seleccionado — Usted ha elegido este asiento.<br />
        <i class="fas fa-chair" style="color: gold;"></i> Bloqueado temporalmente — Otro usuario está en proceso de pago.<br />
        <i class="fas fa-chair" style="color: orange;"></i> Reservado por llamada — Bloqueado por secretaría. Se libera 3 horas antes de la salida si no se realiza el pago.
    </div>
</div>
