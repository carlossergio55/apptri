@page "/comprar-public"
@layout PublicLayout
@using Infraestructura.Models.Integracion
@using MudBlazor
@inject NavigationManager Nav
@inject ISnackbar Snackbar
@using Infraestructura.Models.Clasificador
@using Microsoft.AspNetCore.Components
@using Syncfusion.Blazor.Grids
@using System.Globalization
@inherits MainBaseComponent

<link href="styles/Integracion/comprar-public.css" rel="stylesheet" />


<MudContainer MaxWidth="MaxWidth.Medium" Class="comp-public-contenedor mt-10">
    
    <MudPaper Elevation="3" Class="comp-public-formulario p-6 rounded-xl">
        
        <!-- Título centrado y botón limpiar a la izquierda -->
        <MudText Typo="Typo.h4" Class="comp-public-titulo">
            BUSCAR SALIDAS
        </MudText>
        <MudText Class="ver-tutorial-btn" OnClick="@AbrirTutorial" Style="cursor: pointer;">
            ▶ Ver tutorial
        </MudText>
        <MudGrid Class="mb-6" AlignItems="AlignItems.Center">
            <MudItem xs="12">
                <MudButton Variant="Variant.Text"
                           Size="Size.Small"
                           StartIcon="@Icons.Material.Filled.Clear"
                           OnClick="LimpiarCampos"
                           Class="comp-public-limpiar-boton">
                    Limpiar
                </MudButton>
            </MudItem>
        </MudGrid>

        <!-- Primera fila: origen, duración y destino -->
        <MudGrid Class="mb-4">
            <MudItem xs="12" md="4">
                <MudText Class="comp-public-etiqueta">Seleccione ciudad de origen</MudText>
                <MudSelect T="string"
                          
                           @bind-Value="OrigenSeleccionado"
                           Variant="Variant.Outlined"
                           Margin="Margin.Dense">
                    @foreach (var ciudad in _listaRutas?.Select(r => r.Origen).Distinct() ?? Enumerable.Empty<string>())
                    {
                        <MudSelectItem Value="@ciudad">@ciudad</MudSelectItem>
                    }
                </MudSelect>
            </MudItem>

            <MudItem xs="12" md="4" Class="d-flex justify-center align-center">
                @if (!string.IsNullOrWhiteSpace(OrigenSeleccionado) && !string.IsNullOrWhiteSpace(DestinoSeleccionado))
                {
                    var duracion = _listaRutas?
                    .FirstOrDefault(r => r.Origen == OrigenSeleccionado && r.Destino == DestinoSeleccionado)?.Duracion;

                    <MudChip Color="Color.Info" Variant="Variant.Filled">
                        @($"Duración: {duracion ?? "N/D"}")
                    </MudChip>
                }
            </MudItem>

            <MudItem xs="12" md="4">
                <MudText Class="comp-public-etiqueta">Seleccione ciudad de destino</MudText>
                <MudSelect T="string"
                           
                           @bind-Value="DestinoSeleccionado"
                           Variant="Variant.Outlined"
                           Margin="Margin.Dense">
                    @foreach (var ciudad in _listaRutas?.Select(r => r.Destino).Distinct() ?? Enumerable.Empty<string>())
                    {
                        <MudSelectItem Value="@ciudad">@ciudad</MudSelectItem>
                    }
                </MudSelect>
            </MudItem>
        </MudGrid>


        <!-- Segunda fila: fecha y pasajeros -->
        <MudGrid Class="mb-6">
            <MudItem xs="12" md="6">
                <MudText Class="comp-public-etiqueta">Seleccione fecha de salida</MudText>
                <MudDatePicker @bind-Date="FechaSalida"
                               Variant="Variant.Outlined"
                               Dense="true"
                               Class="comp-public-campo" />
            </MudItem>

            <MudItem xs="12" md="6">
                <MudText Class="comp-public-etiqueta">Número de pasajeros</MudText>
                <MudNumericField @bind-Value="CantidadPasajeros"
                                 Min="1"
                                 Max="10"
                                 Variant="Variant.Outlined"
                                 Dense="true"
                                 Class="comp-public-campo" />
            </MudItem>
        </MudGrid>

        <!-- Botones centrados -->
        @inject NavigationManager Nav

        <MudStack Direction="Row" Justify="Justify.Center" AlignItems="AlignItems.Center" Spacing="2">
            <MudButton Variant="Variant.Filled"
                       OnClick="@(() => Nav.NavigateTo("/comprar-asiento"))"
                       Class="comp-public-boton-buscar"
                       EndIcon="@Icons.Material.Filled.Search">
                Buscar
            </MudButton>
        </MudStack>

    </MudPaper>
</MudContainer>


@code {
    private List<string> Rutas = new() { "Sucre", "Serrano", "Tomina", "Mendoza" };

    private string OrigenSeleccionado;
    private string DestinoSeleccionado;
    private DateTime? FechaSalida = DateTime.Today;
    private int CantidadPasajeros = 1;

    void BuscarPasajes()
    {
        if (string.IsNullOrWhiteSpace(OrigenSeleccionado) || string.IsNullOrWhiteSpace(DestinoSeleccionado))
        {
            Snackbar.Add("Seleccione ciudad de origen y destino.", Severity.Warning);
            return;
        }

        Nav.NavigateTo($"/resultados?origen={OrigenSeleccionado}&destino={DestinoSeleccionado}&fecha={FechaSalida:yyyy-MM-dd}&pasajeros={CantidadPasajeros}");
    }

    void LimpiarCampos()
    {
        OrigenSeleccionado = null;
        DestinoSeleccionado = null;
        FechaSalida = DateTime.Today;
        CantidadPasajeros = 1;
    }
    void AbrirTutorial()
    {
        Nav.NavigateTo("https://www.youtube.com/watch?v=VIDEO_ID", true);
    }
}
